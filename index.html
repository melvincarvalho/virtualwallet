<html>
<head>

  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">

  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <script src="bower_components/materialize/dist/js/materialize.min.js"></script>
  <script src="bower_components/angularjs/angular.js"></script>
  <script src="bower_components/angular-ui-router/release/angular-ui-router.js"></script>
  <!-- Vendor specific deps -->
  <script src="app/vendor/common.js"></script>
  <script src="app/vendor/rdflib.js/rdflib.js"></script>
  <script src="app/vendor/sha256.js"></script>  <!-- App -->
  <script src="app/app.js"></script>

  <script src="bower_components/webcomponentsjs/webcomponents.js"></script>
  <link rel="import" href="bower_components/core-collapse/core-collapse.html">
  <link rel="import" href="bower_components/core-icons/core-icons.html">
  <link rel="import" href="bower_components/core-item/core-item.html">
  <link rel="import" href="bower_components/core-media-query/core-media-query.html">
  <link rel="import" href="bower_components/core-pages/core-pages.html">
  <link rel="import" href="bower_components/core-scaffold/core-scaffold.html">
  <link rel="import" href="bower_components/core-toolbar/core-toolbar.html">
  <link rel="import" href="bower_components/font-roboto/roboto.html">
  <link rel="import" href="bower_components/paper-dropdown/paper-dropdown.html">
  <link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
  <link rel="import" href="bower_components/paper-input/paper-input.html">
  <link rel="import" href="bower_components/paper-fab/paper-fab.html">
  <link rel="import" href="bower_components/paper-tab/paper-tab.html">
  <link rel="import" href="bower_components/paper-tabs/paper-tabs.html">

  <link rel="import" href="login.html">

  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

  <style>
    .gold {
      background-color: #FFFF99;
      width: 25px;
      font-weight: bold;
    }
    .minus {
      color: #CD171C;
      font-weight: 700;
    }
    .plus {
      color: #178817;
      font-weight: 700;
    }
  </style>

</head>

<body>
  <core-toolbar class="medium-tall">

    <paper-icon-button icon="menu"></paper-icon-button>
    <div flex>Virtual Wallet</div>
    <paper-icon-button icon="search"></paper-icon-button>
    <paper-icon-button icon="more-vert"></paper-icon-button>

    <div class="bottom fit" horizontal layout>

      <paper-tabs selected="0" flex style="max-width: 600px;">




        <paper-tab>Balance</paper-tab>
        <paper-tab>History</paper-tab>
        <paper-tab>Pay</paper-tab>
        <paper-tab>Withdraw</paper-tab>

      </paper-tabs>



    </div>


  </core-toolbar>

  <core-pages selected="home">


    <div class="tab-pane active" id="balance">


      <div class="tab-pane active" id="home">

        <form id="create" role="form">
          <div class="form-group">
            <webid-login></webid-login>
            <h2 id="amount"></h2>
          </div>
        </form>
      </div>


    </div>


    <div class="tab-pane" label="history">

      <div class="tab-pane" id="history">

        <div id="history">
          <span id="txmain">You do not yet have any marking history</span>
          <span id="txtable"></span>

        </div>


      </div>

    </div>

    <div class="tab-pane" lebel="pay">

      <form id="create" role="form">

        <div class="form-group">
          <span id="friends"></span>
        </div>
      </form>
    </div>

    <div class="tab-pane" lebel="withdraw">

      <form id="create" role="form">

        <div class="form-group">
          <span id="withdraw"></span>
        </div>
      </form>
    </div>

  </core-pages>



















  <!-- detect when window is narrow -->
  <core-media-query id="mediaQuery" query="max-width: 640px"></core-media-query>

  <script>
  var tabs = document.querySelector('paper-tabs');
  var pages = document.querySelector('core-pages');

  tabs.addEventListener('core-select',function(){
    pages.selected = tabs.selected;
  });
  </script>



  <script>

  document.querySelector('#mediaQuery').addEventListener('core-media-change',
  function(e) {
    document.body.classList.toggle('core-narrow', e.detail.matches);
    //document.querySelector('#scrollableTabs').updateBar();
  });

  </script>


  <script>

  // Globals
  var __kb;
  var __profile;
  var PROXY = "https://rww.io/proxy.php?uri={uri}";
  var AUTH_PROXY = "https://rww.io/auth-proxy?uri=";
  var TIMEOUT = 90000;
  var DEBUG = true;
  // Namespaces
  var RDF = $rdf.Namespace("http://www.w3.org/1999/02/22-rdf-syntax-ns#");
  var RDFS = $rdf.Namespace("http://www.w3.org/2000/01/rdf-schema#");
  var FOAF = $rdf.Namespace("http://xmlns.com/foaf/0.1/");
  var OWL = $rdf.Namespace("http://www.w3.org/2002/07/owl#");
  var SPACE = $rdf.Namespace("http://www.w3.org/ns/pim/space#");
  var UI = $rdf.Namespace("http://www.w3.org/ns/ui#");
  var DCT = $rdf.Namespace("http://purl.org/dc/terms/");
  var CERT = $rdf.Namespace("http://www.w3.org/ns/auth/cert#");
  var ACL = $rdf.Namespace("http://www.w3.org/ns/auth/acl#");

  $rdf.Fetcher.crossSiteProxyTemplate=PROXY;

  var g = $rdf.graph();
  var f = $rdf.fetcher(g);







var paymentProvider = 'https://klaranet.com/d/user/';


  // Listen to WebIDAuth events
  window.addEventListener('WebIDAuth',function(e) {
    console.log(e.detail);
    if (e.detail.success === true) {
      console.log("Auth successful! WebID: "+e.detail.user);
      localStorage.setItem('webid', e.detail.user);
      $('webid-login').hide();
      init(e.detail.user);
      // presence
    } else {
      console.log("Auth failed!");
      console.log(e.detail);
    }
  },false);



















  // init
  var init = function() {



    // Event listener for login (from child iframe)
    var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
    var eventListener = window[eventMethod];
    var messageEvent = eventMethod == "attachEvent" ? "onmessage" : "message";

    // Listen to message from child window
    eventListener('WebIDAuth',function(e) {

      var webid = e.detail.user;
      console.log('WebID is : ' + webid);


      function update() {
        console.log('updating');

        // get balance
        var balanceURI = "http://klaranet.com/balance?uri=" + encodeURIComponent(webid);
        var jqxhr = $.ajax( balanceURI )
        .done(function(data) {
          $('#loginmain').hide();
          $('#amount').text('Balance: ' + data);
        })
        .fail(function() {
          console.log('could not get balance');
        });

        // get history
        var txURI = "http://klaranet.com/tx?uri=" + encodeURIComponent(webid);
        var jqxhr = $.ajax( txURI )
        .done(function(data) {
          $('#txmain').hide();

          var table = '';
          if(data.length>0) {
            table += ('<table vocab="https://w3id.org/cc#" class="table table-striped table-bordered table-hover"><thead><tr><th>When</th><th>Source</th><th class="gold">Amount</th><th>Destination</th><th>Why</th></tr></thead>');
          }

          for( var i=0; i<data.length; i++) {
            table +=('<tr>');
            table +=('<td>' + data[i]['timestamp'] + '</td>');
            table +=('<td>' + data[i]['source'] + '</td>');
            table +=('<td class="plus" style="background-color:#FFFF99" >' + data[i]['amount'] + '</td>');
            table +=('<td>' + data[i]['destination'] + '</td>');
            table +=('<td>' + data[i]['description'] + '</td>');
            table +=('</tr>');
          }


          if(data.length>0) {
            table +=('</table>');
          }
          $('#txtable').empty().append(table);

        })
        .fail(function() {
          console.log('could not get tx history');
        });
      }

      update();

      // fetch user data
      f.nowOrWhenFetched(webid.split('#')[0],undefined,function(ok, body){
        var FOAF = $rdf.Namespace("http://xmlns.com/foaf/0.1/");
        var CURR = $rdf.Namespace("https://w3id.org/cc#");
        var RDF = $rdf.Namespace("http://www.w3.org/1999/02/22-rdf-syntax-ns#");

        var person = g.statementsMatching(undefined, RDF('type'), FOAF('Person'))[0];

        console.log(person);

        var subject = person.subject;

        var name = g.any(subject, FOAF('name'));
        var address = g.any(subject, CURR('bitmark'));

        if (name) {
          name = name.value;
          $('#login').html('<a href="#" onclick="clearSession()" role="button"><i class="fa fa-sign-out"></i> ' + name + ' [Logout]</a>');
        } else {
          return;
        }

        var knows = g.statementsMatching(undefined, FOAF('knows'), undefined);
        if ( knows.length > 0 ) {
          var sel = $('<select id="friendsselect">');
          sel.append($("<option>").attr('value','Friends').text('Friends'));
          for (var i=0; i<knows.length; i++) {
            var know = knows[i];
            console.log(know.object.value);
            sel.append($("<option>").attr('value',know.object.value).text(know.object.value));
          }
          $('#friends').append(sel);

          $('#friends').append('<div class="form-group"><input type="text" id="sendamount" size="80" placeholder="send" class="form-control"></div>');
          $('#friends').append('<button id="sendbutton" type="button" class="btn btn-default">Send</button>');



        }

        if (address) {
          address = address.value;

          $('#withdraw').append('<hr><br>');
          $('#withdraw').text('Address: ' + address);

          $('#withdraw').append('<div class="form-group"><input type="text" id="withdrawamount" placeholder="amount" class="form-control"></div>');
          $('#withdraw').append('<button id="withdrawbutton" type="button" class="btn btn-default">Withdraw</button>');


          $( "#sendbutton" ).click(function( event ) {
            var source = $('#source').val();
            var destination = $('#friendsselect').val();
            var amount = $('#sendamount').val();

            var err = '';

            if(!amount) err +=('Please enter an amount\n');

            if (isNaN(amount)) err += ('Amount must be a number');
            amount = parseFloat(amount);

            if(err !== '') {
              alert(err);
              return false;
            }

            console.log(amount);

            var wc = '<>  a <https://w3id.org/cc#Credit> ;\n';
            wc += '  <https://w3id.org/cc#source> \n    <' + webid + '> ;\n';
            wc += '  <https://w3id.org/cc#destination> \n    <' + destination + '> ;\n';
            wc += '  <https://w3id.org/cc#amount> "' + amount + '" ;\n';
            wc += '  <https://w3id.org/cc#currency> \n    <https://w3id.org/cc#mark> .\n';



            $('#webcredit').text(wc);


            var hash = CryptoJS.SHA256(webid).toString();

            function putFile(file, data) {
              xhr = new XMLHttpRequest();
              xhr.open('PUT', file, false);
              xhr.setRequestHeader('Content-Type', 'text/turtle; charset=UTF-8');
              xhr.send(data);
            }


            putFile(paymentProvider + hash + '/2', '<> a <https://w3id.org/cc#Credit> ; <https://w3id.org/cc#source> <' + webid +'> ; <https://w3id.org/cc#destination> <' + destination + '> ; <https://w3id.org/cc#amount> "' + amount + '" . ');


            console.log(paymentProvider + hash + '/2', '<> a <https://w3id.org/cc#Credit> ; <https://w3id.org/cc#source> <' + webid + '> ; <https://w3id.org/cc#destination> <' + destination + '> ; <https://w3id.org/cc#amount> "' + amount + '" . ');


            setTimeout(update, 2000);
            $('.nav-tabs li:eq(1) a').tab('show');


          });


          $( "#withdrawbutton" ).click(function( event ) {
            var source = $('#source').val();
            var destination = $('#destination').val();
            var amount = $('#withdrawamount').val();

            var err = '';

            if(!amount) err +=('Please enter an amount\n');

            if (isNaN(amount)) err += ('Amount must be a number');
            amount = parseFloat(amount);

            if(err !== '') {
              alert(err);
              return false;
            }

            console.log(amount);

            var wc = '<>  a <https://w3id.org/cc#Credit> ;\n';
            wc += '  <https://w3id.org/cc#source> \n    <' + webid + '> ;\n';
            wc += '  <https://w3id.org/cc#destination> \n    <' + address + '> ;\n';
            wc += '  <https://w3id.org/cc#amount> "' + amount + '" ;\n';
            wc += '  <https://w3id.org/cc#currency> \n    <https://w3id.org/cc#mark> .\n';



            $('#webcredit').text(wc);
            console.log(wc);


            var hash = CryptoJS.SHA256(webid).toString();

            function putFile(file, data) {
              xhr = new XMLHttpRequest();
              xhr.open('PUT', file, false);
              xhr.setRequestHeader('Content-Type', 'text/turtle; charset=UTF-8');
              xhr.send(data);
            }

            putFile(paymentProvider + hash + '/1', '<> a <https://w3id.org/cc#Credit> ; <https://w3id.org/cc#source> <' + webid +'> ; <https://w3id.org/cc#destination> <' + address + '> ; <https://w3id.org/cc#amount> "' + amount + '" . ');


            console.log(paymentProvider + hash + '/1', '<> a <https://w3id.org/cc#Credit> ; <https://w3id.org/cc#source> <' + webid + '> ; <https://w3id.org/cc#destination> <' + address + '> ; <https://w3id.org/cc#amount> "' + amount + '" . ');


            setTimeout(update, 2000);
            $('.nav-tabs li:eq(1) a').tab('show');



          });





        } else {
          alert('Please add a bitmark address to your profile');
        }



        console.log(name);
        console.log(address);

      });


    },false);



    // render form
    $('#source').focus();
    $('#result').attr('rows', 10);




  }

  $(document).ready(init);
  </script>


</body>
</html>
